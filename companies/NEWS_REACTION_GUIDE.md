# Инструкция по реакции на новость

Цель — определить, можно ли спекулятивно заработать на конкретной новости о компании. Быстрый анализ (не полный research), результат — trade signal с условиями входа и выхода.

> **Когда использовать:** при появлении новой новости в `companies/{TICKER}/data/news.json`. Запуск: `make news-reaction TICKER={TICKER}` или вручную по инструкции ниже.

## Пре-условия

Проверь перед началом. Если хотя бы одно не выполнено → **skip**, не тратим время:

| Условие | Где проверить | Почему skip |
|---------|---------------|-------------|
| `_index.md` заполнен | `sentiment` ≠ пусто, `my_fair_value` > 0 | Без фундаментальной оценки нет точки отсчёта для target |
| ADV ≥ 50 млн ₽ | `_index.md` → `adv_rub_mln` или `data/moex_market.json` | Неликвид — не выйдешь по своей цене |

## Шаг 0. Обновить цену

```bash
python3 scripts/update_prices.py {TICKER}
```

Скрипт обновит `current_price` в `_index.md` и добавит строку в `data/price_history.csv`. Без актуальной цены расчёт бессмысленный.

## Шаг 1. Классификация новости

Прочитай последнюю (или указанную) новость из `data/news.json`.

**Определи тип новости:**

| Тип | Примеры | Типичное влияние на цену |
|-----|---------|--------------------------|
| `results` | Квартальный/годовой отчёт, предварительные результаты | Сильное, если расхождение с ожиданиями |
| `dividends` | Объявление дивидендов, изменение payout | Среднее-сильное |
| `regulation` | Санкции, налоги, блокировки ФНС, изменение тарифов | Сильное |
| `corporate` | M&A, buyback, допэмиссия, делистинг, смена менеджмента | Сильное |
| `macro` | Ставка ЦБ, курс, инфляция (влияет на компанию) | Среднее |
| `noise` | Мнения аналитиков, пересказ старых новостей, прогнозы | Слабое |

**Фильтр по силе (из news.json):**

| `strength` | Действие |
|------------|----------|
| `high` | Анализируем |
| `medium` | Анализируем, если `impact` ≠ `neutral` |
| `low` | **Skip** — не стоит времени |

Если в news.json есть `summary` — используй его для понимания контекста. Если нет — прочитай новость по `url`.

## Шаг 2. Проверка «уже в цене»

Цель — понять, отреагировал ли рынок на новость и есть ли ещё пространство для заработка.

**Рассчитай:**

```
1. pre_news_price = цена закрытия за торговый день ДО новости (из price_history.csv)
2. current_price = текущая цена (из _index.md, после шага 0)
3. price_move = (current_price - pre_news_price) / pre_news_price × 100%
4. volume_ratio = volume в день новости / ADV за 30 дней (ADV из moex_market.json)
```

**Матрица решений:**

| price_move (абс.) | volume_ratio | Вердикт |
|--------------------|-------------|---------|
| < 2% | любой | Рынок **не отреагировал** → окно возможности открыто |
| 2–5% | < 2× | **Частично в цене**, но есть пространство |
| 2–5% | > 2× | **В цене** → ищем перепроданность (негатив) или skip (позитив) |
| > 5% | любой | **Сильная реакция** → возможна перепроданность / перекупленность |

**Два сценария для заработка:**

| Сценарий | Когда | Логика |
|----------|-------|--------|
| **long-positive** | Новость позитивная + цена ещё НЕ отреагировала (price_move < 2%) | Покупка до реакции рынка. Рынок медленный или новость вышла после закрытия торгов |
| **long-oversold** | Новость негативная + цена ПЕРЕРЕАГИРОВАЛА (price_move > 5% вниз) + фундаментал НЕ сломан | Покупка на панике. Рынок переоценил негатив, цена вернётся к справедливой |

Если ни один сценарий не подходит → **skip**.

## Шаг 3. Оценка фундаментала

Прочитай из `_index.md`:
- `sentiment`, `position`, `my_fair_value`, `upside`
- `key_risks`, `key_opportunities`
- Секцию «Мой тезис»

**Ключевой вопрос: новость МЕНЯЕТ фундаментальный тезис или нет?**

| Меняет тезис | Примеры | Действие |
|-------------|---------|----------|
| **Да, ломает** | Делистинг, дефолт, потеря ключевого клиента/лицензии, SDN-санкции | **Skip** + предложить обновить `_index.md` (sentiment → bearish) |
| **Да, усиливает** | Рекордная прибыль при bearish-consensus, неожиданные дивиденды | Торгуем с высокой уверенностью |
| **Нет, временная** | Блокировка счетов (потом разблокировали), разовый штраф, слухи | Торгуем, если цена перереагировала |
| **Нет, шум** | Переупаковка известной информации | **Skip** |

**Дополнительная проверка для long-oversold:**
- Посмотри `key_risks` — если новость подтверждает уже известный риск, падение может продолжиться
- Посмотри `Net Debt/EBITDA` — если > 3x и новость про долг/ликвидность → осторожно, может не быть отскока
- Есть ли ближайший катализатор (отчёт, дивиденды, заседание ЦБ), который развернёт sentiment?

## Шаг 4. Расчёт trade setup

**Entry (цена входа):**

| Сценарий | Entry |
|----------|-------|
| long-positive (рынок не отреагировал) | По рынку (текущая цена) |
| long-oversold (паника) | Текущая цена ИЛИ лимитка на уровень поддержки (52w low из moex_market.json) |

**Target (цена выхода с прибылью):**

| Сценарий | Target |
|----------|--------|
| long-positive | `my_fair_value` из `_index.md` (полный upside) |
| long-oversold | `pre_news_price` (возврат к цене до новости) — консервативный вариант. Или `my_fair_value` — агрессивный |

**Stop-loss:**

| Тип новости | Stop-loss | Логика |
|-------------|-----------|--------|
| results (отчётность) | −10% от entry | Волатильность выше на отчётах |
| dividends | −5% от entry | Узкий стоп, идея конкретная |
| regulation / corporate | −10% от entry | Регуляторный риск непредсказуем |
| long-oversold (паника) | Минимум дня паники (low из price_history.csv) | Если пробьёт дно паники — падение продолжится |

**Расчёт risk/reward:**

```
expected_return = (target - entry) / entry × 100%
risk = (entry - stop_loss) / entry × 100%
risk_reward = expected_return / risk
```

**Минимальный risk_reward: 2.0.** Если < 2.0 → **skip**. Не стоит рисковать без достаточного вознаграждения.

**Time limit:**

| Сценарий | Таймфрейм |
|----------|-----------|
| long-positive (отчёт/дивиденды) | 5–10 торговых дней |
| long-oversold (паника) | 10–20 торговых дней |
| long-positive (макро, ставка ЦБ) | до следующего заседания ЦБ |

Если за time_limit цена не двинулась к target → выход по рынку (opportunity cost).

**Размер позиции (на основе confidence):**

| Confidence | Позиция | Когда |
|------------|---------|-------|
| high | full (до 5% портфеля) | risk_reward > 3, новость однозначная, ликвидность высокая |
| medium | half (до 3% портфеля) | risk_reward 2–3, есть неопределённость |
| low | **skip** | risk_reward < 2 или слишком много неизвестных |

## Шаг 5. Решение и запись

**Решение:**

| Сигнал | Условия |
|--------|---------|
| **buy** | risk_reward ≥ 2.0 + катализатор понятен + ликвидность ок + тезис не сломан |
| **skip** | Всё остальное (тезис сломан, r/r < 2, шум, уже в цене, неликвид) |

**Запись результата:**

Добавь сигнал в начало массива `companies/{TICKER}/data/trade_signals.json` (новые сигналы сверху). Формат — по схеме `api/trade-signals-schema.yaml`.

Пример:

```json
{
  "date": "2026-02-25",
  "trigger": "ФНС заблокировала счета на 223 млн ₽, но разблокировала через день",
  "trigger_url": "https://smart-lab.ru/blog/1269071.php",
  "signal": "skip",
  "direction": "skip",
  "confidence": "low",
  "entry": null,
  "exit": null,
  "expected_return_pct": null,
  "risk_reward_ratio": null,
  "position_size": "skip",
  "reasoning": "Негатив частично в цене (−3.5%), но ND/EBITDA > 3x — структурный риск долга не позволяет уверенно ставить на отскок. Нет ближайшего позитивного катализатора."
}
```

## Связь с другими гайдами

| Гайд | Как связан |
|------|-----------|
| `RESEARCH_GUIDE.md` | Если `_index.md` — заглушка, сначала проведи полный research |
| `SPECULATIVE_GUIDE.md` | Используй таблицу стоп-лоссов по типу идеи; Speculative Score — для приоритизации между несколькими сигналами |
| `russia/macro.md` | Даты заседаний ЦБ — катализатор для макро-новостей |

## Антипаттерны

| Ошибка | Почему плохо | Как избежать |
|--------|-------------|--------------|
| Покупка на негативе без проверки фундаментала | «Поймать нож» — цена может падать дальше | Шаг 3: тезис сломан → skip |
| Покупка позитива после реакции цены | Новость уже в цене, upside исчерпан | Шаг 2: price_move > 5% + volume > 2× ADV → skip |
| Игнорирование risk/reward | «Заработаю 5%, рискну 15%» — математика против | Шаг 4: r/r < 2 → skip |
| Торговля без time limit | Позиция зависает, замораживает капитал | Шаг 4: всегда ставь time_limit |
| Реакция на шум | «Аналитик сказал buy» — не катализатор | Шаг 1: strength: low → skip |
| Торговля неликвидом | Не выйдешь по своей цене | Пре-условие: ADV < 50 → skip |